name: Deploy DashFinance para VPS

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Instalar dependências
      working-directory: ./finance-oraculo-frontend
      run: npm ci
    
    - name: Build
      working-directory: ./finance-oraculo-frontend
      run: npm run build
    
    - name: Compactar arquivo
      run: |
        tar -czf dashfinance-frontend.tar.gz \
          finance-oraculo-frontend/.next \
          finance-oraculo-frontend/public \
          finance-oraculo-frontend/package.json \
          finance-oraculo-frontend/package-lock.json
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H 147.93.183.55 >> ~/.ssh/known_hosts
    
    - name: Upload para VPS
      run: |
        scp -i ~/.ssh/id_ed25519 dashfinance-frontend.tar.gz root@147.93.183.55:/var/www/dashfinance/
    
    - name: Deploy no VPS
      run: |
        ssh -i ~/.ssh/id_ed25519 root@147.93.183.55 << 'EOF'
        cd /var/www/dashfinance
        
        # Backup
        cp -r . ../dashfinance-backup-$(date +%s) || true
        
        # Parar servidor
        pkill -f 'npm run start' || true
        sleep 2
        
        # Extrair
        tar -xzf dashfinance-frontend.tar.gz
        rm dashfinance-frontend.tar.gz
        
        # Instalar
        npm install --production
        
        # Iniciar
        nohup npm run start > /var/log/dashfinance.log 2>&1 &
        sleep 3
        
        # Verificar
        if pgrep -f 'npm run start' > /dev/null; then
          echo "✅ Deploy concluído com sucesso!"
        else
          echo "❌ Erro ao iniciar servidor"
          exit 1
        fi
        EOF
    
    - name: Notificar sucesso
      if: success()
      run: echo "✅ Deploy concluído! Acesse http://147.93.183.55:3000"
    
    - name: Notificar erro
      if: failure()
      run: echo "❌ Deploy falhou! Verifique os logs."
